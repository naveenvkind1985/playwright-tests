name: Medical AI E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  MEDICAL_APP_URL: 'https://katalon-demo-cura.herokuapp.com'

jobs:
  # Job 1: Setup (runs once)
  setup:
    name: ‚öôÔ∏è Setup Environment
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache.outputs.cache-key }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Generate cache key
      id: cache
      run: echo "cache-key=${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}" >> $GITHUB_OUTPUT

  # Job 2: Parallel Test Execution (Industry Standard)
  e2e-tests:
    name: üß™ E2E Tests - ${{ matrix.project }} - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        project: [ai-workflows, patient-registration, multilingual]
        browser: [chromium]
        include:
          - project: ai-workflows
            test_dir: tests/e2e/ai-case-processing
          - project: patient-registration
            test_dir: tests/e2e/medical
          - project: multilingual
            test_dir: tests/e2e/multilingual

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Cache Playwright
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/ms-playwright
          node_modules
        key: ${{ needs.setup.outputs.cache-key }}

    - name: Install dependencies
      run: |
        npm ci
        npx playwright install

    - name: Run Playwright Tests
      run: |
        npx playwright test ${{ matrix.test_dir }} \
          --project=${{ matrix.browser }} \
          --reporter=html,json \
          --retries=1
      env:
        MEDICAL_APP_URL: ${{ env.MEDICAL_APP_URL }}

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.project }}-${{ matrix.browser }}
        path: |
          playwright-report/
          test-results/
        retention-days: 7

  # Job 3: Generate Consolidated Report
  reports:
    name: üìä Test Reports
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()

    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-artifacts

    - name: Create Summary
      run: |
        echo "# üè• Medical AI Test Summary" > summary.md
        echo "## Execution Date: $(date)" >> summary.md
        echo "## Test Matrix Results:" >> summary.md
        echo "- ‚úÖ Parallel execution: ${{ needs.e2e-tests.result }}"
        echo "## Artifacts Available:" >> summary.md
        find all-artifacts -name "playwright-report" -type d | while read dir; do
          echo "- $(basename $(dirname $dir))" >> summary.md
        done

    - name: Upload Final Report
      uses: actions/upload-artifact@v4
      with:
        name: test-execution-summary
        path: |
          summary.md
          all-artifacts/
        retention-days: 30

  # Job 4: Quality Gate
  quality-gate:
    name: ‚úÖ Quality Gate
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()

    steps:
    - name: Check Test Results
      run: |
        if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
          echo "‚úÖ All tests passed - Quality gate approved"
          exit 0
        else
          echo "‚ùå Some tests failed - Quality gate rejected"
          exit 1
        fi